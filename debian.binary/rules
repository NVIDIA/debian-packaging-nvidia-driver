#!/usr/bin/make -f


CFLAGS = -Wall -g
ifneq (,$(filter noopt,$(DEB_BUILD_OPTIONS)))
	CFLAGS += -O0
else
	CFLAGS += -O2
endif
ifneq (,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
	NUMJOBS = $(patsubst parallel=%,%,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
	MAKEFLAGS += -j$(NUMJOBS)
endif

DEB_HOST_GNU_TYPE   ?= $(shell dpkg-architecture -qDEB_HOST_GNU_TYPE)
DEB_BUILD_GNU_TYPE  ?= $(shell dpkg-architecture -qDEB_BUILD_GNU_TYPE)


# Prefix of the target package name
PACKAGE		= nvidia-kernel

-include /usr/share/modass/include/generic.make
-include /usr/share/modass/include/common-rules.make

configure:
	sed 's/#KVERS#/$(KVERS)/g' debian/control.template > $(CURDIR)/debian/control
	sed 's/#KVERS#/$(KVERS)/g' debian/dirs.template > $(CURDIR)/debian/dirs
	sed 's/#KVERS#/$(KVERS)/g' debian/override.template > $(CURDIR)/debian/override

binary-modules: configure
	dh_testroot
	dh_quilt_patch

	dh_prep

ifneq (,$(wildcard makefile))
	@echo "ERROR: unclean build directory from older version found, please clean first:"
	@echo "    module-assistant clean nvidia"
	@exit 1
endif

	# Build the modules
	$(MAKE) -C . LINUXDIR=$(KSRC) KVERREL=$(KVERS)

	# Install the modules
	dh_installdirs
	install -m 0644 $(CURDIR)/debian/override $(CURDIR)/debian/nvidia-kernel-$(KVERS)/usr/share/lintian/overrides/nvidia-kernel-$(KVERS)
	install -m 0644 $(CURDIR)/nvidia.ko $(CURDIR)/debian/nvidia-kernel-$(KVERS)/lib/modules/$(KVERS)/nvidia/nvidia.ko ; \

	dh_installdocs
	dh_installmodules
	dh_installchangelogs
	dh_installmodules
	dh_strip
	dh_compress
	dh_fixperms
	dh_installdeb
	dh_gencontrol -- -v$(VERSION)
	dh_md5sums
	dh_builddeb  --destdir=$(KPKG_DEST_DIR)
	dh_prep

clean:
	dh_testdir
	if [ -f $(CURDIR)/debian/control.template ]; then \
		cp  $(CURDIR)/debian/control.template $(CURDIR)/debian/control; \
	fi

	dh_testroot
	rm -f build-stamp configure-stamp

	$(MAKE) clean SYSSRC=$(KSRC) -C $(CURDIR)/$(dirname) -f Makefile $(KPKG_EXTRAV_ARG)
        
	-rm $(CURDIR)/$(dirname)/gcc-check
	-rm $(CURDIR)/$(dirname)/cc-sanity-check

	dh_quilt_unpatch
	dh_clean

	-rm $(CURDIR)/debian/control
	-rm $(CURDIR)/debian/dirs
	-rm $(CURDIR)/debian/override


binary_modules: binary-modules	
	   

# The kdist_configure target is called by make-kpkg modules_config. It
# should configure the module so it is ready for compilation (mostly
# useful for calling configure)
kdist_config kdist_configure:
	$(MAKE) $(MFLAGS) -f debian/rules configure

# the kdist_clean target is called by make-kpkg modules_clean. It is
# responsible for cleaning up any changes that have been made by the
# other kdist_commands (except for the .deb files created).
kdist_clean: configure
	dh_testdir
	$(MAKE) -C . LINUXDIR=$(KSRC) KVERREL=$(KVERS) clean
	dh_quilt_unpatch || quilt --quiltrc /dev/null pop -af
	dh_clean

.PHONY: clean binary-modules
