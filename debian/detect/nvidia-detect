#!/bin/bash

shopt -s compat31 nocasematch 2>/dev/null || { echo "Error: this script only works with bash. Execute it or source it from bash:\n$ . nvidia-versions.sh" && exit; } # Avoid cryptic failure when running dash on this script
NVGA=$(lspci -mn|awk '/"?0300"? "?(10de)|(12d2)"?/{ gsub("\"","") ; print $4 }')
CARDS=`echo $NVGA|wc -w`
if [ $CARDS == 1 ]; then

	if [[ $NVGA =~ "(0020)|(0028)|(0029)|(002C)|(002D)|(0040)|(0041)|(0045)|(004E)|(00A0)|(00C1)|(00C2)|(00C8)|(00C9)|(00CC)|(00CC)|(00CD)|(00CE)|(00F0)|(00F1)|(00F2)|(00F3)|(00F3)|(00F8)|(00F9)|(00FA)|(00FB)|(00FC)|(00FD)|(00FE)|(00FF)|(0100)|(0101)|(0103)|(0110)|(0111)|(0112)|(0113)|(0140)|(0141)|(0144)|(0145)|(0146)|(0148)|(014E)|(014F)|(0150)|(0151)|(0152)|(0153)|(0161)|(0162)|(0164)|(0166)|(0167)|(0168)|(0170)|(0171)|(0172)|(0173)|(0174)|(0175)|(0176)|(0177)|(0178)|(0179)|(017A)|(017C)|(017D)|(0181)|(0182)|(0183)|(0185)|(0188)|(018A)|(018B)|(018C)|(01A0)|(01F0)|(0200)|(0201)|(0202)|(0203)|(0211)|(0212)|(0215)|(0250)|(0251)|(0253)|(0258)|(0259)|(025B)|(0280)|(0281)|(0282)|(0286)|(0288)|(0289)|(028C)|(0301)|(0302)|(0308)|(0309)|(0311)|(0312)|(0314)|(031A)|(031B)|(031C)|(0320)|(0321)|(0322)|(0323)|(0324)|(0325)|(0326)|(0327)|(0328)|(032A)|(032B)|(032C)|(032D)|(0330)|(0331)|(0332)|(0333)|(0334)|(0338)|(033F)|(0341)|(0342)|(0343)|(0344)|(0347)|(0348)|(034C)|(034E)" ]];
	then VERSIONS[${#VERSIONS[*]}]=71.86;
	fi

	if [[ $NVGA =~ "(0040)|(0041)|(0043)|(0044)|(0045)|(0046)|(0047)|(0048)|(004E)|(0090)|(0091)|(0092)|(0093)|(0098)|(0099)|(009D)|(00C0)|(00C1)|(00C2)|(00C3)|(00C8)|(00C9)|(00CC)|(00CD)|(00CE)|(00F0)|(00F1)|(00F2)|(00F3)|(00F4)|(00F5)|(00F6)|(00F8)|(00F9)|(00FA)|(00FB)|(00FC)|(00FD)|(00FE)|(00FF)|(0110)|(0111)|(0112)|(0113)|(0140)|(0141)|(0142)|(0143)|(0144)|(0145)|(0146)|(0148)|(0149)|(014A)|(014C)|(014E)|(014F)|(0160)|(0161)|(0164)|(0165)|(0166)|(0167)|(0168)|(0170)|(0171)|(0172)|(0173)|(0174)|(0175)|(0176)|(0177)|(0178)|(0179)|(017A)|(017C)|(017D)|(0181)|(0182)|(0183)|(0185)|(0188)|(018A)|(018B)|(018C)|(01A0)|(01D1)|(01D7)|(01D7)|(01D8)|(01DA)|(01DB)|(01DC)|(01DE)|(01DF)|(01F0)|(0200)|(0201)|(0202)|(0203)|(0211)|(0212)|(0215)|(0218)|(0240)|(0241)|(0242)|(0250)|(0251)|(0253)|(0258)|(0259)|(025B)|(0280)|(0281)|(0282)|(0286)|(0288)|(0289)|(028C)|(0290)|(0291)|(0298)|(0299)|(029A)|(029B)|(029C)|(029D)|(029E)|(029F)|(02E1)|(0301)|(0302)|(0308)|(0309)|(0311)|(0312)|(0314)|(031A)|(031B)|(031C)|(0320)|(0321)|(0322)|(0323)|(0324)|(0325)|(0326)|(0327)|(0328)|(032A)|(032B)|(032C)|(032D)|(0330)|(0331)|(0332)|(0333)|(0334)|(0338)|(033F)|(0341)|(0342)|(0343)|(0344)|(0347)|(0348)|(034C)|(034E)|(0391)|(0392)|(0398)|(039E)" ]];
	then VERSIONS[96]=96.43;
	fi

	if [[ $NVGA =~ "(0040)|(0041)|(0042)|(0043)|(0044)|(0045)|(0046)|(0047)|(0048)|(0090)|(0091)|(0092)|(0093)|(0095)|(0098)|(0099)|(00C0)|(00C1)|(00C2)|(00C3)|(00C8)|(00C9)|(00F0)|(00F1)|(00F2)|(00F3)|(00F4)|(00F5)|(00F6)|(00F9)|(00FA)|(00FB)|(00FC)|(0140)|(0141)|(0142)|(0143)|(0144)|(0145)|(0146)|(0147)|(0148)|(0149)|(014F)|(0160)|(0161)|(0162)|(0163)|(0164)|(0166)|(0167)|(0168)|(0169)|(016A)|(0191)|(0193)|(0194)|(0197)|(01D0)|(01D1)|(01D3)|(01D6)|(01D7)|(01D8)|(01DD)|(01DF)|(0211)|(0212)|(0215)|(0218)|(0221)|(0222)|(0240)|(0241)|(0242)|(0244)|(0247)|(0290)|(0291)|(0292)|(0293)|(0294)|(0295)|(0297)|(0298)|(0299)|(02E0)|(02E1)|(02E3)|(02E4)|(0301)|(0302)|(0311)|(0312)|(0314)|(031A)|(031B)|(0320)|(0321)|(0322)|(0323)|(0324)|(0325)|(0326)|(0327)|(0328)|(032C)|(032D)|(0330)|(0331)|(0332)|(0333)|(0334)|(0341)|(0342)|(0343)|(0344)|(0347)|(0348)|(0390)|(0391)|(0392)|(0393)|(0394)|(0395)|(0398)|(0399)|(03D0)|(03D1)|(03D2)|(03D5)|(0400)|(0401)|(0402)|(0403)|(0404)|(0405)|(0407)|(0408)|(0409)|(0420)|(0421)|(0422)|(0423)|(0424)|(0425)|(0426)|(0427)|(0428)|(042E)|(0531)|(0533)|(053A)|(053B)|(053E)|(0600)|(0602)|(0604)|(0606)|(0609)|(060C)|(060D)|(0610)|(0611)|(0612)|(0622)|(0647)|(0648)|(0649)|(064B)|(06E4)|(06E5)|(06E8)|(06E9)|(07E0)|(07E1)|(07E3)|(0844)|(0848)|(0849)|(084A)|(084B)|(084F)|(004E)|(009D)|(00CC)|(00CD)|(00CE)|(00F8)|(00FC)|(00FD)|(00FE)|(014A)|(014C)|(014D)|(014E)|(0165)|(019D)|(019E)|(01D7)|(01DA)|(01DB)|(01DC)|(01DE)|(0245)|(029A)|(029B)|(029C)|(029D)|(029E)|(029F)|(0308)|(0309)|(031C)|(032A)|(032B)|(0338)|(033F)|(034C)|(034E)|(039E)|(040A)|(040B)|(040C)|(040D)|(040E)|(040F)|(0429)|(042A)|(042B)|(042D)|(042F)|(061A)|(061C)" ]];
	then VERSIONS[173]=173.14;
	fi

	if [[ $NVGA =~ "(0040)|(0041)|(0042)|(0043)|(0044)|(0045)|(0046)|(0047)|(0048)|(0090)|(0091)|(0092)|(0093)|(0095)|(0098)|(0099)|(00C0)|(00C1)|(00C2)|(00C3)|(00C8)|(00C9)|(00F1)|(00F2)|(00F3)|(00F4)|(00F5)|(00F6)|(00F9)|(0140)|(0141)|(0142)|(0143)|(0144)|(0145)|(0146)|(0147)|(0148)|(0149)|(014F)|(0160)|(0161)|(0162)|(0163)|(0164)|(0166)|(0167)|(0168)|(0169)|(016A)|(0191)|(0193)|(0194)|(0197)|(01D0)|(01D1)|(01D2)|(01D3)|(01D6)|(01D7)|(01D8)|(01DD)|(01DF)|(0221)|(0222)|(0240)|(0241)|(0242)|(0244)|(0247)|(0290)|(0291)|(0292)|(0293)|(0294)|(0295)|(0297)|(0298)|(02E0)|(02E1)|(02E2)|(02E3)|(02E4)|(038B)|(0390)|(0391)|(0392)|(0393)|(0394)|(0395)|(0397)|(0398)|(0399)|(03D0)|(03D1)|(03D2)|(03D5)|(03D6)|(0400)|(0401)|(0402)|(0403)|(0404)|(0405)|(0406)|(0407)|(0408)|(0409)|(0410)|(0420)|(0421)|(0422)|(0423)|(0424)|(0425)|(0426)|(0427)|(0428)|(042C)|(042E)|(0531)|(0533)|(053A)|(053B)|(053E)|(05E0)|(05E1)|(05E2)|(05E3)|(05E6)|(05E7)|(05EA)|(05EB)|(0600)|(0601)|(0602)|(0603)|(0604)|(0605)|(0606)|(0607)|(0608)|(0609)|(060A)|(060B)|(060C)|(060D)|(060F)|(0610)|(0611)|(0612)|(0613)|(0614)|(0615)|(0617)|(0618)|(0622)|(0623)|(0625)|(0626)|(0627)|(0628)|(062A)|(062B)|(062C)|(062D)|(062E)|(0631)|(0632)|(0635)|(0637)|(0640)|(0641)|(0643)|(0644)|(0645)|(0646)|(0647)|(0648)|(0649)|(064A)|(064B)|(064C)|(0651)|(0652)|(0653)|(0654)|(0656)|(065B)|(06C0)|(06CD)|(06D1)|(06E0)|(06E1)|(06E2)|(06E3)|(06E4)|(06E5)|(06E6)|(06E7)|(06E8)|(06E9)|(06EC)|(06EF)|(06F1)|(07E0)|(07E1)|(07E2)|(07E3)|(07E5)|(0844)|(0845)|(0846)|(0847)|(0848)|(0849)|(084A)|(084B)|(084C)|(084D)|(084F)|(0860)|(0861)|(0862)|(0863)|(0864)|(0865)|(0866)|(0867)|(0868)|(086A)|(086C)|(086D)|(086E)|(086F)|(0870)|(0871)|(0872)|(0873)|(0874)|(0876)|(087A)|(087D)|(087E)|(087F)|(0A20)|(0A23)|(0A28)|(0A29)|(0A2A)|(0A2B)|(0A2D)|(0A34)|(0A35)|(0A60)|(0A62)|(0A63)|(0A64)|(0A65)|(0A66)|(0A68)|(0A69)|(0A6E)|(0A6F)|(0A70)|(0A71)|(0A72)|(0A73)|(0A74)|(0A75)|(0CA0)|(0CA2)|(0CA3)|(0CA4)|(0CA7)|(0CA8)|(0CA9)|(0CAF)|(0CB0)|(0CB1)|(004E)|(009D)|(00CC)|(00CD)|(00CE)|(00F8)|(014A)|(014C)|(014D)|(014E)|(0165)|(019D)|(019E)|(01DA)|(01DB)|(01DC)|(01DE)|(0245)|(0299)|(029A)|(029B)|(029C)|(029D)|(029E)|(029F)|(039C)|(039E)|(040A)|(040B)|(040C)|(040D)|(040E)|(040F)|(0429)|(042A)|(042B)|(042D)|(042F)|(05ED)|(05F8)|(05F9)|(05FD)|(05FE)|(05FF)|(0619)|(061A)|(061B)|(061C)|(061D)|(061E)|(061F)|(0638)|(063A)|(0658)|(0659)|(065A)|(065C)|(06EA)|(06EB)|(06F8)|(06F9)|(06FA)|(06FB)|(06FD)|(06FF)|(0A2C)|(0A3C)|(0A6A)|(0A6C)|(0A78)|(0A7C)|(0CBC)" ]];
	then VERSIONS[195]=195.36.24;
	fi

	if [[ $NVGA =~ "(0040)|(0041)|(0042)|(0043)|(0044)|(0045)|(0046)|(0047)|(0048)|(0090)|(0091)|(0092)|(0093)|(0095)|(0098)|(0099)|(00C0)|(00C1)|(00C2)|(00C3)|(00C8)|(00C9)|(00F1)|(00F2)|(00F3)|(00F4)|(00F5)|(00F6)|(00F9)|(0140)|(0141)|(0142)|(0143)|(0144)|(0145)|(0146)|(0147)|(0148)|(0149)|(014F)|(0160)|(0161)|(0162)|(0163)|(0164)|(0166)|(0167)|(0168)|(0169)|(016A)|(0191)|(0193)|(0194)|(0197)|(01D0)|(01D1)|(01D2)|(01D3)|(01D6)|(01D7)|(01D8)|(01DD)|(01DF)|(0221)|(0222)|(0240)|(0241)|(0242)|(0244)|(0247)|(0290)|(0291)|(0292)|(0293)|(0294)|(0295)|(0297)|(0298)|(02E0)|(02E1)|(02E2)|(02E3)|(02E4)|(038B)|(0390)|(0391)|(0392)|(0393)|(0394)|(0395)|(0397)|(0398)|(0399)|(03D0)|(03D1)|(03D2)|(03D5)|(03D6)|(0400)|(0401)|(0402)|(0403)|(0404)|(0405)|(0406)|(0407)|(0408)|(0409)|(0410)|(0420)|(0421)|(0422)|(0423)|(0424)|(0425)|(0426)|(0427)|(0428)|(042C)|(042E)|(0531)|(0533)|(053A)|(053B)|(053E)|(05E0)|(05E1)|(05E2)|(05E3)|(05E6)|(05E7)|(05E7)|(05E7)|(05E7)|(05E7)|(05EA)|(05EB)|(0600)|(0601)|(0602)|(0603)|(0604)|(0605)|(0606)|(0607)|(0608)|(0609)|(060A)|(060B)|(060C)|(060D)|(060F)|(0610)|(0611)|(0612)|(0613)|(0614)|(0615)|(0617)|(0618)|(0622)|(0623)|(0625)|(0626)|(0627)|(0628)|(062A)|(062B)|(062C)|(062D)|(062E)|(0631)|(0632)|(0635)|(0637)|(0640)|(0641)|(0643)|(0644)|(0645)|(0646)|(0647)|(0648)|(0649)|(064A)|(064B)|(064C)|(0651)|(0652)|(0653)|(0654)|(0656)|(065B)|(06C0)|(06C4)|(06CA)|(06CD)|(06D1)|(06D1)|(06D2)|(06DE)|(06DE)|(06DE)|(06DF)|(06E0)|(06E1)|(06E2)|(06E3)|(06E4)|(06E5)|(06E6)|(06E7)|(06E8)|(06E9)|(06EC)|(06EF)|(06F1)|(07E0)|(07E1)|(07E2)|(07E3)|(07E5)|(0844)|(0845)|(0846)|(0847)|(0848)|(0849)|(084A)|(084B)|(084C)|(084D)|(084F)|(0860)|(0861)|(0862)|(0863)|(0864)|(0865)|(0866)|(0867)|(0868)|(086A)|(086C)|(086D)|(086E)|(086F)|(0870)|(0871)|(0872)|(0873)|(0874)|(0876)|(087A)|(087D)|(087E)|(087F)|(08A5)|(0A20)|(0A22)|(0A23)|(0A26)|(0A27)|(0A28)|(0A29)|(0A2A)|(0A2B)|(0A2D)|(0A34)|(0A35)|(0A60)|(0A62)|(0A63)|(0A64)|(0A65)|(0A66)|(0A67)|(0A68)|(0A69)|(0A6E)|(0A6F)|(0A70)|(0A71)|(0A72)|(0A73)|(0A74)|(0A75)|(0A7A)|(0CA0)|(0CA2)|(0CA3)|(0CA4)|(0CA7)|(0CA8)|(0CA9)|(0CAC)|(0CAF)|(0CB0)|(0CB1)|(0DC0)|(0DC4)|(0DCD)|(0DD1)|(0DD2)|(0DD6)|(0DE0)|(0DE1)|(0DE2)|(0DE5)|(0DEC)|(0DEE)|(0DF0)|(0DF1)|(0DF2)|(0DF3)|(0DF5)|(0DF6)|(0DF7)|(0E22)|(0E23)|(0E24)|(0E30)|(0E31)|(1040)|(1050)|(1080)|(1081)|(1082)|(1088)|(1091)|(1094)|(1096)|(10C3)|(10C5)|(1200)|(1201)|(1241)|(1244)|(1245)|(1251)|(004E)|(009D)|(00CC)|(00CD)|(00CE)|(00F8)|(014A)|(014C)|(014D)|(014E)|(0165)|(019D)|(019E)|(01DA)|(01DB)|(01DC)|(01DE)|(0245)|(0299)|(029A)|(029B)|(029C)|(029D)|(029E)|(029F)|(039C)|(039E)|(040A)|(040B)|(040C)|(040D)|(040E)|(040F)|(0429)|(042A)|(042B)|(042D)|(042F)|(05ED)|(05F8)|(05F9)|(05FD)|(05FE)|(05FF)|(0619)|(061A)|(061B)|(061C)|(061D)|(061E)|(061F)|(0638)|(063A)|(0658)|(0659)|(065A)|(065C)|(06D8)|(06D9)|(06DA)|(06DC)|(06DD)|(06EA)|(06EB)|(06F8)|(06F9)|(06FA)|(06FB)|(06FD)|(06FF)|(0A2C)|(0A38)|(0A3C)|(0A6A)|(0A6C)|(0A78)|(0A7C)|(0CBC)|(0DD8)|(0DD8)|(0DDA)|(0DF8)|(0DFA)|(0E3A)|(0E3B)|(1055)|(1056)|(109A)|(109B)|(10D8)" ]];
	then VERSIONS[999]=275.21; # 999 means current
	fi


	if [[ ${#VERSIONS[*]} == 0 ]]
	then echo "Uh oh. Your card is not supported by any driver version."
	exit;
	fi

	if grep -q "lenny\|5" /etc/debian_version;
	then
		if [[ -n ${VERSIONS[173]} ]];
		then
			if [[ -n ${VERSIONS[96]} ]];
			then echo "Your card is supported by all driver versions.";
			else
			echo "Your card is supported by the default drivers.";
			fi;
		elif [[ -n ${VERSIONS[96]} ]]; then
			echo "Your card is only supported up to the 96.43 legacy drivers series. You can use VERSION=\"-legacy-96xx\"";
		else
			if [[ -n ${VERSIONS[71]} ]]; then
				echo "Uh oh. Your card is only supported by the 71.86 legacy drivers series, which is not in any current Debian suite.";
			else
				echo "Uh oh. Your card is only supported by the current drivers series, which is only in Squeeze.";
			fi;
		fi;
	elif grep -q "squeeze\|^6" /etc/debian_version;
	then
		if [[ -n ${VERSIONS[195]} ]];
		then
			if [[ -n ${VERSIONS[173]} ]];
				then
				if [[ -n ${VERSIONS[96]} ]];
					then echo "Your card is supported by all driver versions.";
				else
					echo "Your card is supported by the default drivers and version 173.";
				fi;
			else
				echo "Your card is supported by the default drivers.";
			fi;
		elif [[ -n ${VERSIONS[173]} ]]; then
			echo "Your card is only supported up to the 173.14 legacy drivers series. You can use VERSION=\"-legacy-173xx\"";
		elif [[ -n ${VERSIONS[96]} ]]; then
			echo "Your card is only supported up to the 96.43 legacy drivers series. You can use VERSION=\"-legacy-96xx\"";
		elif [[ -n ${VERSIONS[999]} ]]; then
			echo "Uh oh. Your card is only supported by a newer version of the current drivers series.";
		else
			echo "Uh oh. Your card is only supported by the 71.86 legacy drivers series, which is not in any current Debian suite.";
		fi;
	elif grep -q "wheezy" /etc/debian_version;
	then
		if [[ -n ${VERSIONS[999]} ]];
		then
			if [[ -n ${VERSIONS[173]} ]];
				then
				if [[ -n ${VERSIONS[96]} ]];
					then echo "Your card is supported by all driver versions.";
				else
					echo "Your card is supported by the default drivers and version 173.";
				fi;
			else
			echo "Your card is supported by the default drivers.";
			fi;
		elif [[ -n ${VERSIONS[173]} ]]; then
			echo "Your card is only supported up to the 173.14 legacy drivers series. You can use VERSION=\"-legacy-173xx\"";
		elif [[ -n ${VERSIONS[96]} ]]; then
			echo "Uh oh. Your card is only supported up to the 96.43 legacy drivers series, which is not in Wheezy.";
		else
			echo "Uh oh. Your card is only supported by the 71.86 legacy drivers series, which is not in any current Debian suite.";
		fi;
	elif grep -q "4" /etc/debian_version;
	then
		echo "Uh oh. You are running Etch, which is no longer supported.";
	else
		echo "Uh oh. Failed to identify your Debian suite.";
	fi;

elif [ $CARDS == 0 ]; then echo "No NVIDIA card detected."
	else echo "Several NVIDIA cards detected. Check support manually."
fi

#To generate a new PCI IDs list, $ awk 'BEGIN {ORS=")|("} /0x/{print substr($0,match($0, "0x")+2,4)}' < 190.42
# where 190.42 is a text file with a paste of the content from http://us.download.nvidia.com/XFree86/Linux-x86/190.42/README/appendix-a.html
