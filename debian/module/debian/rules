#!/usr/bin/make -f


CFLAGS = -Wall -g
ifneq (,$(filter noopt,$(DEB_BUILD_OPTIONS)))
	CFLAGS += -O0
else
	CFLAGS += -O2
endif
ifneq (,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
	NUMJOBS = $(patsubst parallel=%,%,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
	MAKEFLAGS += -j$(NUMJOBS)
endif

DEB_HOST_GNU_TYPE   ?= $(shell dpkg-architecture -qDEB_HOST_GNU_TYPE)
DEB_BUILD_GNU_TYPE  ?= $(shell dpkg-architecture -qDEB_BUILD_GNU_TYPE)


# Prefix of the target package name
PACKAGE		= nvidia-kernel

include /usr/share/modass/include/generic.make
include /usr/share/modass/include/common-rules.make

configure:
	sed 's/#KVERS#/$(KVERS)/g' debian/control.template > debian/control
	sed 's/#KVERS#/$(KVERS)/g' debian/install.template > debian/install

binary-modules: configure
	dh_testroot
	dh_quilt_patch

	dh_prep

ifneq (,$(wildcard makefile))
	@echo "ERROR: unclean build directory from older version found, please clean first:"
	@echo "    module-assistant clean nvidia"
	@exit 1
endif

	# Build the modules
	$(MAKE) -C . LINUXDIR=$(KSRC) KVERREL=$(KVERS)

	# Install the modules
	dh_installdirs
	dh_install
	dh_installdocs $(wildcard debian/changelog.nvidia-kernel-source*)
	dh_installchangelogs NVIDIA_Changelog
	dh_installmodules
	dh_bugfiles
	dh_strip
	dh_compress
	dh_fixperms
	dh_installdeb
	dh_gencontrol -- -v$(VERSION)
	dh_md5sums
	dh_builddeb  --destdir=$(KPKG_DEST_DIR)
	dh_prep

clean:
	test -f debian/control || cp debian/control.template debian/control
	dh_testdir
	dh_testroot
	rm -f build-stamp configure-stamp

	$(MAKE) -C . -f Makefile SYSSRC=$(KSRC) $(KPKG_EXTRAV_ARG) clean
        
	dh_quilt_unpatch
	dh_clean

	rm -f debian/install
	rm -f debian/control


binary_modules: binary-modules	
	   

# The kdist_configure target is called by make-kpkg modules_config. It
# should configure the module so it is ready for compilation (mostly
# useful for calling configure)
kdist_config kdist_configure:
	$(MAKE) $(MFLAGS) -f debian/rules configure

# the kdist_clean target is called by make-kpkg modules_clean. It is
# responsible for cleaning up any changes that have been made by the
# other kdist_commands (except for the .deb files created).
kdist_clean:
	test -f debian/control || cp debian/control.template debian/control
	dh_testdir
	$(MAKE) -C . LINUXDIR=$(KSRC) KVERREL=$(KVERS) clean
	dh_quilt_unpatch || quilt --quiltrc /dev/null pop -af
	dh_clean

.PHONY: clean binary-modules
