From 7d7270c82d42b55d28c0ead553f22f3ec17e2049 Mon Sep 17 00:00:00 2001
From: Andreas Beckmann <anbe@debian.org>
Date: Sat, 25 Apr 2020 11:42:24 +0200
Subject: [PATCH 4/4] backport nv_timeval changes from 440.82 (uvm part)

---
 nvidia-uvm/nvidia-uvm.Kbuild |  3 +++
 nvidia-uvm/uvm_linux.h       | 11 +++++++++--
 2 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/nvidia-uvm/nvidia-uvm.Kbuild b/nvidia-uvm/nvidia-uvm.Kbuild
index ebc19ab..100ab6c 100644
--- a/nvidia-uvm/nvidia-uvm.Kbuild
+++ b/nvidia-uvm/nvidia-uvm.Kbuild
@@ -102,6 +102,7 @@ NV_CONFTEST_FUNCTION_COMPILE_TESTS += pci_bus_address
 NV_CONFTEST_FUNCTION_COMPILE_TESTS += set_memory_uc
 NV_CONFTEST_FUNCTION_COMPILE_TESTS += set_pages_uc
 NV_CONFTEST_FUNCTION_COMPILE_TESTS += acpi_walk_namespace
+NV_CONFTEST_FUNCTION_COMPILE_TESTS += ktime_get_raw_ts64
 
 NV_CONFTEST_TYPE_COMPILE_TESTS += proc_dir_entry
 NV_CONFTEST_TYPE_COMPILE_TESTS += irq_handler_t
@@ -123,3 +124,5 @@ NV_CONFTEST_TYPE_COMPILE_TESTS += vm_ops_fault_removed_vma_arg
 NV_CONFTEST_TYPE_COMPILE_TESTS += node_states_n_memory
 NV_CONFTEST_TYPE_COMPILE_TESTS += kmem_cache_has_kobj_remove_work
 NV_CONFTEST_TYPE_COMPILE_TESTS += sysfs_slab_unlink
+NV_CONFTEST_TYPE_COMPILE_TESTS += proc_ops
+NV_CONFTEST_TYPE_COMPILE_TESTS += timeval
diff --git a/nvidia-uvm/uvm_linux.h b/nvidia-uvm/uvm_linux.h
index b140f44..a7f01a4 100644
--- a/nvidia-uvm/uvm_linux.h
+++ b/nvidia-uvm/uvm_linux.h
@@ -322,9 +322,16 @@ static inline uint64_t NV_DIV64(uint64_t dividend, uint64_t divisor, uint64_t *r
 /* Return a nanosecond-precise value */
 static inline NvU64 NV_GETTIME(void)
 {
+/*
+ * Use ktime_get_raw_ts64() instead of getrawmonotonic() when it is available.
+ */
+#if defined(NV_KTIME_GET_RAW_TS64_PRESENT)
+    struct timespec64 ts = {0};
+    ktime_get_raw_ts64(&ts);
+#else
     struct timespec ts = {0};
-
     getrawmonotonic(&ts);
+#endif
 
     /* Wraps around every 583 years */
     return (ts.tv_sec * 1000000000ULL + ts.tv_nsec);
@@ -334,7 +341,7 @@ static inline NvU64 NV_GETTIME(void)
  * available non-GPL symbols. */
 static inline NvU64 NV_GETTIME(void)
 {
-    struct timeval tv = {0};
+    nv_timeval tv = {0};
 
     nv_gettimeofday(&tv);
 
-- 
2.20.1

